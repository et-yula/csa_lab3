# Лабораторная работа №3. Отчет
- P3220, Гурская Юлия Владимировна
- `lisp -> asm | acc | harv | hw | instr | struct | stream | port | cstr | prob1 | cache`

## Язык программирования

Lisp-подобный. S-expressions. Любое выражение -- expression

BNF: 
```
s_expression ::= atomic_symbol | "(" s_expression+ ")"
atomic_symbol ::= name | string | number
name ::= [A-Za-z][A-Za-z0-9]*
string ::= '"' [^"] '"' | "'" [^'] "'"
number = 0 | [1-9][0-9]*
```

## Организация памяти

### Память команд
Реализуется списком словарей, описывающих инструкции (одно слово -- одна ячейка).

### Память данных 

- Линейное адресное пространство. Адресуется числами от 0 до n
- Одна ячейка - 32 бит.

## Система команд

#### режимы адресации
| Пример | Описание |
| ----- | ---- |
| 5 | Прямая загрузка |
| [5] | Косвенная адресация |
| SP+5 | Косвенная адресация, со смещением (SP) |
| [SP+5] | Косвенная относительная адресация, со смещением (SP) |

### Набор инструкций
Операции с памятью:
- `LD` - загружает в аккумулятор указанное значение
- `ST` - сохраняет значение из аккумулятора в указанную ячейку памяти

Арифметические операции (результат записывается в аккумулятор):
- `ADD` - произвести сложение аккумулятора с указанным значением
- `SUB` - произвести вычитание аккумулятора с указанным значением
- `MUL` - произвести умножение аккумулятора с указанным значением
- `DIV` - произвести деление аккумулятора с указанным значением
- `MOD` - вычисление остатка от деления аккумулятора с указанным значением
- `CMP` - установить флаги по вычитанию указанного значения из аккумулятора

Инструкции перехода:
- `JMP` - безусловный переход на указанное место
- `JE` - переход на указанное место, если флаг 'Z' равен 1. Переход, если равно
- `JNE` - переход на указанное место, если флаг 'Z' равен 0. Переход, если не равно
- `JGE` - переход на указанное место, если флаг 'N' равен 0. Переход, если больше или равно

Инструкции подпрограмм:
- `CALL` - вызов подпрограммы
- `RET` - возврат из функции

Операции со стеком:
- `PUSH` - положить на вершину стека значение аккумулятора
- `POP` - записать в аккумулятор значение из вершины стека

Операции ввода-вывода:
- `IN` - прочитать байт в аккумулятор
- `OUT` - вывести младший байт аккумулятора

Остальные:
- `NOP`
- `HALT` - остановить процессор

### Кодирование инструкций

- Машинный код сериализуется в список JSON.
- Один элемент списка -- одна инструкция.
- Индекс списка -- адрес инструкции. Используется для команд перехода.

  
Пример:
```json
[
    {
        "instruction": "LD",
        "operand": "33"
    },
    {
        "instruction": "OUT"
    },
    {
        "instruction": "HALT"
    }
]
```
Первым элементов списка JSON может быть массив инициализирующих(загружаемых при старте) данных:
```json
[
    [33, 0],
    {
        "instruction": "LD",
        "operand": "[0]"
    },
    {
        "instruction": "OUT"
    },
    {
        "instruction": "HALT"
    }
]
```
## Транслятор
- Интерфейс командной строки: `translator.py <input_file> <target_file>`

## Модель процессора

### DataPath
```
     ! Каждый MUX имеет селектор, но ради упрощения схемы они не отображены

                         ^                  |
                         |32bit             |PR
                         |                  |16bit
     +---+---------------+                  |
     |   |               |                  |
     |   |   |           |                  |
     |   |   | inp    _C___S_               |
     |   v   v       /       \  alu_op      |
     | +-------+    /   ___   \<------      |
     | | MUX_A |   /   /   \   \            |
     | +-------+  +---/     \---+         sign
     |    |         ^         ^         extension
     |    |latch_ac |         |             |
     |    v         |         |             |32bit
     | +----+   +-------+ +-------+         |
     | | AC |-->| MUX_L | | MUX_R |<--------+
     | +----+   +-------+ +-------+
     |     |     ^     ^   ^  ^  ^
     | out |     |     |   |  |  |
     |     v     |    (0)  | (0) +---------------+----+
     |           |         |     |               |    |
     |           |         |     |             (+1)  (-1)
     |           |         |     |               |    |
     |           |         |     |               v    v
     |latch_ar+----+    +----+ +----+ latch_sp +-------+
     +------->| AR |    | DR | | SP |<---------| MUX_S |
     |        +----+    +----+ +----+          +-------+
     |           |         ^
     |           |         |           |    |
     |value      |address  |data_out   |wr  |oe
     v           v         |           v    v
    +---------------------------------------------------+
    |  data                                             |
    |  memory                                           |
    +---------------------------------------------------+
```
- data_memory -- однопортовая, поэтому либо читаем, либо пишем.
- input/output -- токенизированная логика ввода-вывода. Не детализируется в рамках модели.
- input -- чтение может вызвать остановку процесса моделирования, если буфер входных значений закончился.

Реализованные методы соответствуют сигналам защёлкивания значений:
- `signal_latch_ip` -- защёлкивание адреса следующей выполняемой команды;
- `signal_latch_ac` -- защёлкивание аккумулятора;
- `signal_latch_ar` -- защёлкивание адреса в памяти;
- `signal_latch_sp` -- защёлкивание адреса вершины стека;
- `signal_oe` -- чтение из память;
- `signal_wr` -- запись в память;
- `signal_out` -- вывод в порт.

Сигнал "исполняется" за один такт. Корректность использования сигналов -- задача `ControlUnit`.

### ControlUnit
Блок управления процессора. Выполняет декодирование инструкций и управляет состоянием модели процессора.

```
      +----------------------- +1 -----------+             +---------------------------+
      |                                      |             |                           |
      |                                      v             |                           |
      |      +---------+             +-----------------+   |    +-----------------+    |
      +----->|         |    latch_ip |   instruction   |   |    |     program     |    |
             |   MUX   |------------>|     pointer     |---+--->|      memory     |    |
      +----->|         |             |                 |        |                 |    |
      |      +---------+             +-----------------+        +-----------------+    |
      |             ^                                                    |             |
      |             |                                                    +---------+   |
      |             |                                                    |         |   |
      |             |                                                    |         v   v
      |             |                                                    |      +---------+
      |             |                                                    |      |   MUX   |
      |             |                                                    |      +---------+
      |             |                                                    |           |
      |             |                                                    |           v
      |             |                                                    |   +----------------+
      |             |                                                    |   | trim_low_16bit |
      |             |                                                    |   +----------------+
      |             |                                                    V           |
      |             |                                 +------------------------+     |
      |             +---------------------------------|       instruction      |     |
      |                                               |         decoder        |     |
      |                                               +------------------------+     |
      |                                                     ^            |           |
      |                                                     |            |           |
      |                                                   flags       signals        |
      |                                                     |            |           |
      |                                                     |            V           |
      |                                                  +-----------------+         |
      |                                                  |     DataPath    |<--------+
      |                                                  +-----------------+
      |                                                           |
      +-------------------------- data ---------------------------+
```
